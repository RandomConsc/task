<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI任务管理系统 - 自然语言与JSON混合响应方案</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 20px;
            height: calc(100vh - 40px);
        }
        
        .header {
            grid-column: 1 / -1;
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        
        .chat-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 10px;
            margin-bottom: 15px;
            background: #f9f9f9;
        }
        
        .message {
            padding: 12px 15px;
            margin-bottom: 15px;
            border-radius: 18px;
            max-width: 85%;
            position: relative;
            line-height: 1.5;
        }
        
        .user {
            background: #3498db;
            color: white;
            margin-left: auto;
        }
        
        .assistant {
            background: #ecf0f1;
            color: #2c3e50;
            margin-right: auto;
        }
        
        .input-area {
            display: flex;
            gap: 10px;
        }
        
        input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #3498db;
            border-radius: 50px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s;
        }
        
        input:focus {
            border-color: #e74c3c;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.2);
        }
        
        button {
            padding: 12px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        button:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .task-board {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .tasks-container {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            overflow-y: auto;
            padding: 10px;
        }
        
        .task-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            padding: 20px;
            transition: all 0.3s;
            border-left: 5px solid #3498db;
            position: relative;
        }
        
        .task-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .task-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }
        
        .task-id {
            font-size: 0.8rem;
            color: #7f8c8d;
            background: #f1f2f6;
            padding: 2px 8px;
            border-radius: 10px;
        }
        
        .task-description {
            color: #34495e;
            margin-bottom: 15px;
            min-height: 60px;
        }
        
        .task-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #7f8c8d;
            font-size: 14px;
            border-top: 1px dashed #eee;
            padding-top: 12px;
        }
        
        .task-actions {
            display: flex;
            gap: 10px;
        }
        
        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .edit-btn {
            background: #f1c40f;
            color: white;
        }
        
        .delete-btn {
            background: #e74c3c;
            color: white;
        }
        
        .action-btn:hover {
            transform: scale(1.1);
        }
        
        .status-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #2ecc71;
        }
        
        .debug-panel {
            background: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 14px;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .json-data {
            color: #3498db;
            word-break: break-all;
        }
        
        .role-selector {
            margin-bottom: 15px;
        }
        
        select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 2px solid #3498db;
            background: white;
            font-size: 16px;
        }
        
        @media (max-width: 900px) {
            .container {
                grid-template-columns: 1fr;
                height: auto;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <div class="header">
                <h1><i class="fas fa-robot"></i> AI任务管理系统</h1>
                <p>通过自然对话管理您的任务卡片 - 混合响应解析方案</p>
            </div>
            
            <div class="chat-container">
                <h2><i class="fas fa-comments"></i> 对话界面</h2>
                
                <div class="role-selector">
                    <select v-model="selectedRole">
                        <option value="friendly">友好助手 😊</option>
                        <option value="strict">严格教练 💪</option>
                        <option value="cute">可爱猫娘 🐱</option>
                        <option value="pirate">海盗船长 🏴‍☠️</option>
                    </select>
                </div>
                
                <div class="chat-history">
                    <div v-for="(msg, index) in messages" :key="index" :class="['message', msg.role]">
                        <div v-if="msg.role === 'assistant' && msg.parsedOperation">
                            <i class="fas fa-cogs"></i> 检测到操作指令
                        </div>
                        {{ msg.content }}
                    </div>
                </div>
                <div class="input-area">
                    <input v-model="userInput" placeholder="输入任务指令，如：创建健身任务..." @keyup.enter="sendMessage">
                    <button @click="sendMessage"><i class="fas fa-paper-plane"></i> 发送</button>
                </div>
            </div>
            
            <div class="task-board">
                <h2><i class="fas fa-tasks"></i> 任务看板</h2>
                <div class="tasks-container">
                    <div v-for="task in tasks" :key="task.id" class="task-card">
                        <div class="status-indicator"></div>
                        <h3>{{ task.title }} <span class="task-id">#{{ task.id }}</span></h3>
                        <div class="task-description">{{ task.description }}</div>
                        <div class="task-meta">
                            <div><i class="far fa-calendar"></i> {{ task.due_date }}</div>
                            <div class="task-actions">
                                <div class="action-btn edit-btn" @click="editTask(task.id)">
                                    <i class="fas fa-edit"></i>
                                </div>
                                <div class="action-btn delete-btn" @click="deleteTask(task.id)">
                                    <i class="fas fa-trash"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="debug-panel">
                <h3><i class="fas fa-bug"></i> 调试信息</h3>
                <div>最后操作: <span class="json-data">{{ lastOperation || '无' }}</span></div>
                <div>存储状态: {{ storageStatus }}</div>
                <div>任务数量: {{ tasks.length }}</div>
                <div>当前角色: {{ selectedRole }}</div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;
        
        createApp({
            setup() {
                // 响应式数据
                const userInput = ref('');
                const messages = ref([]);
                const tasks = ref([]);
                const lastOperation = ref(null);
                const storageStatus = ref('已加载');
                const selectedRole = ref('friendly');
                
                // 角色配置文件
                const roleProfiles = {
                    friendly: {
                        name: "友好助手",
                        response: "使用友好、专业的语气回复用户",
                        create: "已为您创建新任务: {title}，截止日期: {due_date}",
                        update: "任务 {title} 已更新，新截止日期: {due_date}",
                        delete: "任务 {title} 已删除"
                    },
                    strict: {
                        name: "严格教练",
                        response: "使用严厉、命令式的语气回复",
                        create: "新任务已设定！{title} - 必须在{due_date}前完成！",
                        update: "任务调整：{title} 新截止时间{due_date}，别想偷懒！",
                        delete: "任务{title}已取消 - 但你要用其他训练弥补！"
                    },
                    cute: {
                        name: "可爱猫娘",
                        response: "使用可爱语气，每句结尾加'喵~'，带emoji",
                        create: "新任务卡片创建成功喵~ 🐾『{title}』记得在{due_date}完成哦！",
                        update: "任务已更新喵~ {title}的新时间是{due_date}，不要忘记喵~ 😽",
                        delete: "任务{title}被放进垃圾桶了喵~ (。>︿<)_θ"
                    },
                    pirate: {
                        name: "海盗船长",
                        response: "使用海盗俚语，每句结尾加'哟嚯~'",
                        create: "新任务已记入航海日志！『{title}』在{due_date}前完成，不然走跳板哟嚯~",
                        update: "任务『{title}』的截止日期改为{due_date}，别让老子失望哟嚯~",
                        delete: "任务『{title}』已被丢进大海喂鲨鱼了哟嚯~ 🦈"
                    }
                };
                
                // 从localStorage加载数据
                const loadFromLocalStorage = () => {
                    try {
                        const savedTasks = localStorage.getItem('tasks');
                        const savedMessages = localStorage.getItem('chatMessages');
                        const savedRole = localStorage.getItem('selectedRole');
                        
                        if (savedTasks) tasks.value = JSON.parse(savedTasks);
                        if (savedMessages) messages.value = JSON.parse(savedMessages);
                        if (savedRole) selectedRole.value = savedRole;
                        
                        storageStatus.value = `已加载 ${tasks.value.length} 个任务`;
                    } catch (e) {
                        console.error('加载数据错误:', e);
                        storageStatus.value = '加载失败';
                    }
                };
                
                // 保存到localStorage
                const saveToLocalStorage = () => {
                    try {
                        localStorage.setItem('tasks', JSON.stringify(tasks.value));
                        localStorage.setItem('chatMessages', JSON.stringify(messages.value));
                        localStorage.setItem('selectedRole', selectedRole.value);
                        storageStatus.value = `已保存 ${tasks.value.length} 个任务`;
                    } catch (e) {
                        console.error('保存数据错误:', e);
                        storageStatus.value = '保存失败';
                    }
                };
                
                // 初始化加载数据
                onMounted(() => {
                    loadFromLocalStorage();
                    // 添加欢迎消息
                    if (messages.value.length === 0) {
                        messages.value.push({
                            role: 'assistant',
                            content: '您好！我是您的AI任务助手，请输入指令如："创建健身任务，明天开始"',
                            parsedOperation: null
                        });
                    }
                });
                
                // 任务操作方法
                const createTask = (taskData) => {
                    const newTask = {
                        id: 'T' + Date.now().toString().slice(-6),
                        title: taskData.title || '新任务',
                        description: taskData.description || '暂无描述',
                        due_date: taskData.due_date || '无截止日期',
                        created_at: new Date().toISOString()
                    };
                    tasks.value.push(newTask);
                    lastOperation.value = `创建任务: ${JSON.stringify(taskData)}`;
                    saveToLocalStorage();
                    return newTask;
                };
                
                const updateTask = (taskData) => {
                    const taskIndex = tasks.value.findIndex(t => t.id === taskData.id);
                    if (taskIndex !== -1) {
                        tasks.value[taskIndex] = {
                            ...tasks.value[taskIndex],
                            ...taskData
                        };
                        lastOperation.value = `更新任务: ${JSON.stringify(taskData)}`;
                        saveToLocalStorage();
                        return tasks.value[taskIndex];
                    }
                    return null;
                };
                
                const deleteTask = (taskId) => {
                    const taskIndex = tasks.value.findIndex(t => t.id === taskId);
                    if (taskIndex !== -1) {
                        const [deletedTask] = tasks.value.splice(taskIndex, 1);
                        lastOperation.value = `删除任务: ${taskId}`;
                        saveToLocalStorage();
                        return deletedTask;
                    }
                    return null;
                };
                
                // 解析AI响应中的操作指令
                const parseAIOperation = (response) => {
                    // 使用正则表达式提取HTML注释中的JSON
                    const match = response.match(/<!--\s*({.*?})\s*-->/s);
                    if (match && match[1]) {
                        try {
                            const operation = JSON.parse(match[1]);
                            // 移除注释，保留自然语言部分
                            const cleanResponse = response.replace(/<!--.*?-->/s, '').trim();
                            return {
                                content: cleanResponse,
                                operation: operation
                            };
                        } catch (e) {
                            console.error('解析操作JSON失败:', e);
                        }
                    }
                    return {
                        content: response,
                        operation: null
                    };
                };
                
                // 发送消息给AI
                const sendMessage = async () => {
                    const input = userInput.value.trim();
                    if (!input) return;
                    
                    // 添加用户消息
                    messages.value.push({
                        role: 'user',
                        content: input
                    });
                    
                    userInput.value = '';
                    
                    try {
                        // 模拟API调用 - 实际项目中替换为真实API
                        const aiResponse = await mockAIService(input);
                        
                        // 解析AI响应
                        const parsed = parseAIOperation(aiResponse);
                        
                        // 添加AI回复
                        const aiMessage = {
                            role: 'assistant',
                            content: parsed.content,
                            parsedOperation: parsed.operation
                        };
                        
                        messages.value.push(aiMessage);
                        
                        // 处理AI返回的操作
                        if (parsed.operation) {
                            handleAIOperation(parsed.operation);
                        }
                        
                        // 保存消息历史
                        saveToLocalStorage();
                    } catch (error) {
                        console.error('处理请求时出错:', error);
                        messages.value.push({
                            role: 'assistant',
                            content: '抱歉，处理您的请求时出错了，请稍后再试',
                            parsedOperation: null
                        });
                    }
                };
                
                // 处理AI返回的操作
                const handleAIOperation = (operation) => {
                    switch (operation.intent) {
                        case 'create':
                            createTask(operation);
                            break;
                        case 'update':
                            updateTask(operation);
                            break;
                        case 'delete':
                            deleteTask(operation.id);
                            break;
                        default:
                            console.warn('未知操作类型:', operation);
                    }
                };
                
                // 模拟AI服务 - 返回混合格式响应
                const mockAIService = async (input) => {
                    return new Promise((resolve) => {
                        setTimeout(() => {
                            const role = roleProfiles[selectedRole.value];
                            
                            // 根据用户输入生成不同的混合响应
                            if (input.includes('添加') || input.includes('创建')) {
                                const title = input.replace('添加', '').replace('创建', '').trim();
                                resolve(
                                    `${role.create.replace('{title}', title).replace('{due_date}', getTomorrowDate())}\n` +
                                    `<!-- {"intent": "create", "title": "${title}", "description": "这是一个新创建的任务", "due_date": "${getTomorrowDate()}"} -->`
                                );
                            } else if (input.includes('修改') || input.includes('更新')) {
                                // 假设存在ID为T123456的任务
                                const task = tasks.value.length > 0 ? tasks.value[0] : {title: "示例任务", id: "T123456"};
                                resolve(
                                    `${role.update.replace('{title}', task.title).replace('{due_date}', getNextWeekDate())}\n` +
                                    `<!-- {"intent": "update", "id": "${task.id}", "due_date": "${getNextWeekDate()}"} -->`
                                );
                            } else if (input.includes('删除') && tasks.value.length > 0) {
                                const taskToDelete = tasks.value[tasks.value.length - 1];
                                resolve(
                                    `${role.delete.replace('{title}', taskToDelete.title)}\n` +
                                    `<!-- {"intent": "delete", "id": "${taskToDelete.id}"} -->`
                                );
                            } else if (input.includes('你好') || input.includes('您好')) {
                                resolve(`${
                                    selectedRole.value === 'friendly' ? '您好！有什么可以帮您的？' :
                                    selectedRole.value === 'strict' ? '别浪费时间！直接说任务！' :
                                    selectedRole.value === 'cute' ? '喵~ 主人有什么吩咐？' :
                                    '哟嚯~ 船长在此！有什么任务？'
                                }`);
                            } else {
                                resolve(`${
                                    selectedRole.value === 'friendly' ? '好的，请问有什么可以帮助您的？' :
                                    selectedRole.value === 'strict' ? '说重点！需要我做什么？' :
                                    selectedRole.value === 'cute' ? '喵~ 主人请指示喵~' :
                                    '哟嚯~ 任务是什么？快说！'
                                }`);
                            }
                        }, 1000);
                    });
                };
                
                // 辅助函数
                const getTomorrowDate = () => {
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    return tomorrow.toISOString().split('T')[0];
                };
                
                const getNextWeekDate = () => {
                    const nextWeek = new Date();
                    nextWeek.setDate(nextWeek.getDate() + 7);
                    return nextWeek.toISOString().split('T')[0];
                };
                
                // UI操作方法
                const editTask = (taskId) => {
                    const task = tasks.value.find(t => t.id === taskId);
                    if (task) {
                        userInput.value = `修改任务 ${taskId}，新标题为"${task.title} (更新版)"`;
                    }
                };
                
                const deleteTaskUI = (taskId) => {
                    deleteTask(taskId);
                };
                
                return {
                    userInput,
                    messages,
                    tasks,
                    lastOperation,
                    storageStatus,
                    selectedRole,
                    sendMessage,
                    deleteTask: deleteTaskUI,
                    editTask
                };
            }
        }).mount('#app');
    </script>
</body>
</html>